<?php
require_once 'config/config.php';
requireLogin();

// Buscar informa√ß√µes do usu√°rio
$stmt = $pdo->prepare("SELECT * FROM usuarios WHERE id = ?");
$stmt->execute([getUserId()]);
$usuario = $stmt->fetch();

// Buscar todas as miss√µes do usu√°rio
$stmt = $pdo->prepare("
    SELECT 
        m.*,
        COALESCE(mu.progresso_atual, 0) as progresso_atual,
        COALESCE(mu.concluida, 0) as concluida,
        mu.data_conclusao
    FROM missoes m
    LEFT JOIN missoes_usuario mu ON m.id = mu.missao_id AND mu.usuario_id = ?
    WHERE m.ativa = 1
    ORDER BY 
        CASE WHEN mu.concluida = 1 THEN 1 ELSE 0 END,
        m.modulo_requerido,
        m.recompensa_pontos DESC
");
$stmt->execute([getUserId()]);
$todas_missoes = $stmt->fetchAll();

// Separar miss√µes por categoria
$missoes_ativas = [];
$missoes_concluidas = [];
$missoes_bloqueadas = [];

foreach ($todas_missoes as $missao) {
    if ($missao['concluida']) {
        $missoes_concluidas[] = $missao;
    } elseif ($missao['modulo_requerido'] <= $usuario['progresso_modulo']) {
        $missoes_ativas[] = $missao;
    } else {
        $missoes_bloqueadas[] = $missao;
    }
}

// Calcular estat√≠sticas
$total_missoes = count($todas_missoes);
$missoes_completas = count($missoes_concluidas);
$pontos_ganhos_missoes = array_sum(array_column($missoes_concluidas, 'recompensa_pontos'));
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miss√µes - Handly</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <a href="home.php" class="logo">ü§ü Handly</a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="home.php">Home</a></li>
                    <li><a href="dicionario.php">Dicion√°rio</a></li>
                    <li><a href="trilha.php">Trilha</a></li>
                    <li><a href="missoes.php" style="background-color: rgba(255,255,255,0.1); border-radius: var(--border-radius);">Miss√µes</a></li>
                    <li><a href="perfil.php">Perfil</a></li>
                    <li><a href="logout.php" class="btn btn-outline">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Cabe√ßalho -->
        <div class="card" style="background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white;">
            <h1 style="color: white; margin-bottom: 1rem;">üèÜ Centro de Miss√µes</h1>
            <p style="opacity: 0.9; font-size: 1.1rem; margin-bottom: 2rem;">
                Complete miss√µes para ganhar pontos e desbloquear conquistas especiais!
            </p>
            
            <!-- Estat√≠sticas -->
            <div class="grid grid-4">
                <div class="text-center">
                    <div class="stat-number" style="color: white;"><?php echo $missoes_completas; ?></div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Miss√µes Completas</div>
                </div>
                <div class="text-center">
                    <div class="stat-number" style="color: white;"><?php echo count($missoes_ativas); ?></div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Miss√µes Ativas</div>
                </div>
                <div class="text-center">
                    <div class="stat-number" style="color: white;"><?php echo $pontos_ganhos_missoes; ?></div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Pontos por Miss√µes</div>
                </div>
                <div class="text-center">
                    <div class="stat-number" style="color: white;"><?php echo $usuario['pontuacao_total']; ?></div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.8);">Pontos Totais</div>
                </div>
            </div>
        </div>

        <!-- Miss√µes Ativas -->
        <?php if (!empty($missoes_ativas)): ?>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üéØ Miss√µes Ativas</h2>
                <p style="color: var(--medium-gray);">
                    Complete estas miss√µes para ganhar pontos e avan√ßar na sua jornada
                </p>
            </div>
            
            <div class="grid grid-2">
                <?php foreach ($missoes_ativas as $missao): ?>
                    <?php 
                    $percentual = $missao['objetivo'] > 0 ? 
                        min(round(($missao['progresso_atual'] / $missao['objetivo']) * 100), 100) : 0;
                    ?>
                    <div class="card">
                        <div class="flex-between" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="color: var(--primary-color); margin: 0;">
                                <?php echo htmlspecialchars($missao['titulo']); ?>
                            </h3>
                            <span class="badge badge-primary">
                                +<?php echo $missao['recompensa_pontos']; ?> pts
                            </span>
                        </div>
                        
                        <p style="color: var(--medium-gray); margin-bottom: 1rem;">
                            <?php echo htmlspecialchars($missao['descricao']); ?>
                        </p>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.9rem;">
                                    Progresso: <strong><?php echo $missao['progresso_atual']; ?> / <?php echo $missao['objetivo']; ?></strong>
                                </span>
                                <span style="font-weight: bold; color: var(--primary-color);">
                                    <?php echo $percentual; ?>%
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: <?php echo $percentual; ?>%"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="badge badge-<?php 
                                echo $missao['modulo_requerido'] == 1 ? 'easy' : 
                                     ($missao['modulo_requerido'] == 2 ? 'medium' : 'hard'); 
                            ?>">
                                M√≥dulo <?php echo $missao['modulo_requerido']; ?>
                            </span>
                            
                            <?php if ($percentual >= 100): ?>
                                <span style="color: var(--success-color); font-weight: bold;">
                                    ‚úÖ Pronto para coleta!
                                </span>
                            <?php else: ?>
                                <span style="color: var(--medium-gray); font-size: 0.875rem;">
                                    Tipo: <?php echo ucfirst(str_replace('_', ' ', $missao['tipo'])); ?>
                                </span>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
        <?php endif; ?>

        <!-- Miss√µes Conclu√≠das -->
        <?php if (!empty($missoes_concluidas)): ?>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">‚úÖ Miss√µes Conclu√≠das</h2>
                <p style="color: var(--medium-gray);">
                    Parab√©ns pelas miss√µes completadas! Aqui est√£o suas conquistas
                </p>
            </div>
            
            <div class="grid grid-3">
                <?php foreach ($missoes_concluidas as $missao): ?>
                    <div class="card" style="background-color: var(--light-gray); border-left: 4px solid var(--success-color);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h4 style="color: var(--success-color); margin: 0;">
                                <?php echo htmlspecialchars($missao['titulo']); ?>
                            </h4>
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                        </div>
                        
                        <p style="color: var(--medium-gray); margin-bottom: 1rem; font-size: 0.9rem;">
                            <?php echo htmlspecialchars($missao['descricao']); ?>
                        </p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="badge badge-primary">
                                +<?php echo $missao['recompensa_pontos']; ?> pts
                            </span>
                            <small style="color: var(--medium-gray);">
                                <?php echo formatDate($missao['data_conclusao']); ?>
                            </small>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
        <?php endif; ?>

        <!-- Miss√µes Bloqueadas -->
        <?php if (!empty($missoes_bloqueadas)): ?>
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üîí Miss√µes Futuras</h2>
                <p style="color: var(--medium-gray);">
                    Estas miss√µes ser√£o desbloqueadas conforme voc√™ progride nos m√≥dulos
                </p>
            </div>
            
            <div class="grid grid-2">
                <?php foreach ($missoes_bloqueadas as $missao): ?>
                    <div class="card" style="opacity: 0.7; border: 2px dashed var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="color: var(--medium-gray); margin: 0;">
                                üîí <?php echo htmlspecialchars($missao['titulo']); ?>
                            </h3>
                            <span class="badge" style="background-color: var(--medium-gray); color: white;">
                                +<?php echo $missao['recompensa_pontos']; ?> pts
                            </span>
                        </div>
                        
                        <p style="color: var(--medium-gray); margin-bottom: 1rem;">
                            <?php echo htmlspecialchars($missao['descricao']); ?>
                        </p>
                        
                        <div style="background-color: var(--warning-color); color: var(--tertiary-color); padding: 0.75rem; border-radius: var(--border-radius); text-align: center;">
                            <strong>Requisito:</strong> M√≥dulo <?php echo $missao['modulo_requerido']; ?>
                            <br>
                            <small>Complete o m√≥dulo <?php echo $missao['modulo_requerido'] - 1; ?> para desbloquear</small>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>
        <?php endif; ?>

        <!-- Tipos de Miss√µes -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìã Tipos de Miss√µes</h2>
            </div>
            
            <div class="grid grid-2">
                <div class="card">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">üéØ Miss√µes de Aprendizado</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;">üìö <strong>Aprender Sinais:</strong> Complete um n√∫mero espec√≠fico de sinais</li>
                        <li style="margin-bottom: 0.5rem;">üìñ <strong>Categoria Completa:</strong> Termine todas as palavras de uma categoria</li>
                        <li style="margin-bottom: 0.5rem;">üéì <strong>M√≥dulo Completo:</strong> Finalize um m√≥dulo inteiro</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">‚ö° Miss√µes de Engajamento</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;">üìÖ <strong>Sequ√™ncia de Dias:</strong> Estude por v√°rios dias consecutivos</li>
                        <li style="margin-bottom: 0.5rem;">üèÜ <strong>Pontua√ß√£o:</strong> Acumule uma quantidade espec√≠fica de pontos</li>
                        <li style="margin-bottom: 0.5rem;">üí™ <strong>Dedica√ß√£o:</strong> Complete atividades di√°rias</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sistema de Pontos -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üíé Sistema de Pontos</h2>
            </div>
            
            <div class="grid grid-3">
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìö</div>
                    <h4>Sinais Aprendidos</h4>
                    <p style="color: var(--medium-gray);">
                        <strong>F√°cil:</strong> 10 pontos<br>
                        <strong>M√©dio:</strong> 20 pontos<br>
                        <strong>Dif√≠cil:</strong> 30 pontos
                    </p>
                </div>
                
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üèÜ</div>
                    <h4>Miss√µes</h4>
                    <p style="color: var(--medium-gray);">
                        Ganhe pontos extras ao completar miss√µes especiais e desafios
                    </p>
                </div>
                
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéØ</div>
                    <h4>Conquistas</h4>
                    <p style="color: var(--medium-gray);">
                        Desbloqueie recompensas especiais e novos conte√∫dos
                    </p>
                </div>
            </div>
        </div>

        <!-- Call to Action -->
        <div class="card text-center" style="background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white;">
            <h2 style="color: white; margin-bottom: 1rem;">Pronto para mais miss√µes?</h2>
            <p style="opacity: 0.9; margin-bottom: 2rem;">
                Continue aprendendo para desbloquear novas miss√µes e ganhar mais pontos!
            </p>
            <div>
                <a href="trilha.php" class="btn btn-large btn-secondary" style="margin-right: 1rem;">
                    üéØ Continuar Trilha
                </a>
                <a href="dicionario.php" class="btn btn-large btn-outline" style="border-color: white; color: white;">
                    üìö Explorar Dicion√°rio
                </a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container text-center">
            <p>&copy; 2025 Handly - Complete miss√µes e torne-se um expert em LIBRAS!</p>
        </div>
    </footer>

    <script>
        // Anima√ß√£o das barras de progresso
        document.addEventListener('DOMContentLoaded', function() {
            const progressBars = document.querySelectorAll('.progress-bar');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const bar = entry.target;
                        const width = bar.style.width;
                        bar.style.width = '0%';
                        
                        setTimeout(() => {
                            bar.style.transition = 'width 1.5s ease-out';
                            bar.style.width = width;
                        }, 200);
                        
                        observer.unobserve(bar);
                    }
                });
            });
            
            progressBars.forEach(bar => {
                observer.observe(bar);
            });
        });

        // Anima√ß√£o dos n√∫meros de estat√≠sticas
        function animarEstatisticas() {
            const statNumbers = document.querySelectorAll('.stat-number');
            
            statNumbers.forEach(stat => {
                const finalValue = parseInt(stat.textContent);
                if (isNaN(finalValue)) return;
                
                let currentValue = 0;
                const increment = Math.ceil(finalValue / 30);
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    stat.textContent = currentValue;
                }, 50);
            });
        }

        // Executar anima√ß√µes quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', animarEstatisticas);

        // Efeito hover nos cards
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                if (!this.style.opacity || this.style.opacity === '1') {
                    this.style.transform = 'translateY(-3px)';
                    this.style.transition = 'transform 0.3s ease';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    </script>
</body>
</html>
